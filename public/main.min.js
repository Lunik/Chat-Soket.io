$(function(){function N(e){var t=getXMLHttpRequest();t.open("GET","json/"+e+".json",false);t.send(null);if(t.readyState!=4||t.status!=200&&t.status!=0)throw new Error('Impossible de charger la list nommée "'+e+'" (code HTTP : '+t.status+").");var n=t.responseText;var r=JSON.parse(n);this.title=r.title;this.liste=r.liste}function C(e){var t="";for(var n=0;n<e;n++){t+="*"}return t}function k(e){var t="";if(e.numUsers===1){t+="1 connected"}else{t+=e.numUsers+" connected"}D(t)}function L(){g=U(f.val().trim());if(g.length>=3){if(g){v.fadeOut();m.show();v.off("click");x=h.focus();T.emit("add user",g)}else{document.getElementById("msg_form").innerHTML="Already used Username"}}}function A(e){var t=e.toLowerCase().split("<").join("*").split(">").join("*");for(var n in o.liste){t=t.split(o.liste[n]).join(C(o.liste[n].length))}for(var r=0;r<e.length;r++){if(t[r]=="*")e=e.substring(0,r)+"*"+e.substring(r+1,e.length)}e=O(e);return e}function O(e){e=e.split('class="twitter-tweet"').join('class="twitter-tweet" data-cards="hidden"');return e}function M(e){var t="";var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var r=0;r<e;r++)t+=n.charAt(Math.floor(Math.random()*n.length));return t}function _(){var e=h.val();var t;var n;var r;var i=M(10);if(w>=1&&w<3){e=U(e).substring(0,1e3)}else if(w>=3){e=U(e)}else{e=U(e).substring(0,500)}if(h.attr("type")=="password"){h.attr("type","")}if(e[0]=="/"){t=j(e);if(t.post){e=t.message;r={username:g,message:e,id:i}}else{n=F(t);e=n;r={username:"<Server>",message:e,id:i}}}else{t={message:"none",post:true};r={username:g,message:e,id:i};if(w<3)r.message=e=A(r.message);else{e=r.message}}if(e){h.val("");P(r);if(b&&t.post){T.emit("send message",{message:e,id:i,rang:w})}}}function D(e,t){var n=$("<li>").addClass("log").text(e);R(n,t)}function P(e,t){var n;var r=W(e);t=t||{};if(r.length!==0){t.fade=false;r.remove()}var i=$('<span class="icon"/>');if(e.username!="<Server>"){if(e.rang>=0){if(e.rang>=1){i.html('<img src="images/rang/lvl-'+e.rang+'.png" />')}}else{if(w>=1){i.html('<img src="images/rang/lvl-'+w+'.png" />')}}}var s=$('<span class="username"/>').text(e.username+" :").css("color",X(e.username));e.message=q(e.message);var o=$('<span class="messageBody">').html(e.message);var u;if(w>=2){u=$('<span class="adminDiv">').html("Delete")}else{u=""}var a=e.typing?"typing":"";var f=new Date;f=f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();var l=$('<span class="dateDiv">').html(f);if(e.mention){if(e.id){e.id="-"+e.id;var c=$('<li class="message'+e.id+' mention"/>').data("username",e.username).addClass(a).append(i,s,o,l,u);G("mention")}}else{if(e.id){e.id="-"+e.id;var c=$('<li class="message'+e.id+'"/>').data("username",e.username).addClass(a).append(i,s,o,l,u)}else{var c=$('<li class="message"/>').data("username",e.username).addClass(a).append(i,s,o,l,u)}}R(c,t)}function H(e){e.typing=true;e.message="...";P(e)}function B(e){W(e).fadeOut(function(){$(this).remove()})}function j(e){var t=e.split(" ");var n=t[0].split("/")[1];switch(n){case"img":var r=t[1];return{message:"<a href='"+r+"' target='_blank'><img src='"+r+"' class='img'/></a>",post:true};case"http:":var r=t[0].substring(1,1e3);return{message:"<a href='"+r+"' target='_blank'>"+r+"</a>",post:true};case"yt":if(w>=1){var r=t[1];var i=r.split("v=")[1];if(!i){var i=r.split("youtu.be/")[1];if(!i){var i=r.split("embed/")[1]}}i=i.split("&")[0];return{message:"<iframe width='560' height='315' src='//www.youtube.com/embed/"+i+"' frameborder='0' allowfullscreen></iframe>",post:true}}else{return{message:"Unknown command",post:false}}break;case"ping":return{message:"ping",post:false};case"help":return{message:"help",post:false};case"version":return{message:"version",post:false};case"quit":return{message:"quit",post:false};case"clear":return{message:"clear",post:false};case"pass":h.attr("type","password");return{message:"pass",parametre:t[1],post:false};case"kick":if(w>=2){return{message:"kick",parametre:t[1],post:false}}else{return{message:"Unknown command",post:false}};case"tw":if(w>=1){return{message:'<blockquote class="twitter-tweet" data-cards="hidden" lang="fr"><a href="https://twitter.com/GuillaumeLunik/status/'+t[1]+'"></blockquote> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>',post:true}}else{return{message:"Unknown command",post:false}}break;case"poule":if(w>=1){return{message:"<img src='http://guillaume-lunik.fr/images/poule.png' class='img'/>",post:true}}else{return{message:"Unknown command",post:false}};case"ls":return{message:"ls",post:false};case"say":if(w>=2){return{message:"say",parametre:t,post:false}}else{return{message:"Unknown command",post:false}};case"announce":if(w>=2){return{message:"announce",parametre:t,post:false}}else{return{message:"Unknown command",post:false}};case"playYt":if(w>=1){var r=t[1];var i=r.split("v=")[1];if(!i){var i=r.split("youtu.be/")[1];if(!i){var i=r.split("embed/")[1]}}i=i.split("&")[0];return{message:"playYt",parametre:i,post:false}}else{return{message:"Unknown command",post:false}};default:return{message:"Unknown command",post:false}}}function F(t){var n=t.message;var r=t.parametre;var i="";switch(n){case"ping":G("ping");i="Pong";break;case"help":i=J();break;case"version":i="Version - "+e;break;case"quit":G("quit");T.disconnect();location.reload();break;case"clear":i="Chat clear";l.html("");break;case"pass":if(r&&I(r)==u.liste.Admin){h.attr("type","");if(w!=3){w=3;i="Connected as Admin"}else{i="Already Connected as Admin"}}else if(r&&I(r)==u.liste.Moderator){h.attr("type","");if(w!=2){w=2;i="Connected as Moderator"}else{i="Already Connected as Moderator"}}else if(r&&I(r)==u.liste.KnownUser){h.attr("type","");if(w!=1){w=1;i="Connected as KnownUser"}else{i="Already Connected as KnownUser"}}else{if(r)i="Wrong Password"}break;case"kick":console.log({username:r.trim(),rang:w});T.emit("kick",{username:r.trim(),rang:w});i="Kick "+r;break;case"ls":i="<span style='text-decoration:underline; font-weight: bold;'>Utilisateurs connectés:</span> ";for(var s in y){i+=" <span style='color:"+X(y[s])+"; font-weight:700;'>"+y[s]+" </span>|"}i=i.substring(0,i.length-1);break;case"say":var o=r.join(" ").split("/say")[1];if(o){o=o.substring(1,o.length);i='Broadcast: "'+o+'"';T.emit("broadcast",{message:o,id:M(10),rang:w})}else{i="Invalide Syntax"}break;case"announce":var a=parseInt(r[1]);if(a){var o=r.join(" ").split("/announce")[1];o=o.split(a)[1].trim();o=O(o);if(o){i='Announce: "'+o+'"';T.emit("announce",{message:o,duree:a})}else{i="Invalide Syntax";G("error")}}else{i="Invalide Syntax";G("error")}break;case"playYt":var f=r;if(f){i='Play: "'+f+'"';var c,p;$.ajax({url:"http://gdata.youtube.com/feeds/api/videos/"+f+"?v=2&alt=json",dataType:"jsonp",success:function(e){c=parseInt(e.entry.media$group.yt$duration.seconds);T.emit("playYt",{video:"<iframe width='560' height='315' src='http://www.youtube.com/embed/"+f+"?autoplay=1&controls=0' frameborder='0'></iframe>",duree:c})}})}else{i="Invalide Syntax";G("error")}break;default:i="Unknown Command";G("error");break}return i}function I(e){var t=7;for(var n=0;n<e.length;n++){t=e.charCodeAt(n)+(t<<5)-t}return t}function q(e){var t=0;var n=e;for(var r in s.liste){if(s.liste[r])n=n.split(r).join("<img src='smiley/"+s.liste[r]+".gif' class='smiley'/>");else n=n.split(r).join(r)}return n}function R(e,n){var r=$(e);if(!n){n={}}if(typeof n.fade==="undefined"){n.fade=true}if(typeof n.prepend==="undefined"){n.prepend=false}if(n.fade){r.hide().fadeIn(t)}if(n.prepend){l.prepend(r)}else{l.append(r)}l[0].scrollTop=l[0].scrollHeight}function U(e){return $("<div/>").text(e).text()}function z(){if(b){if(!E){E=true;T.emit("typing",{username:g,rang:w})}S=(new Date).getTime();setTimeout(function(){var e=(new Date).getTime();var t=e-S;if(t>=n&&E){T.emit("stop typing");E=false}},n)}}function W(e){return $(".typing.message").filter(function(t){return $(this).data("username")===e.username})}function X(e){var t=7;for(var n=0;n<e.length;n++){t=e.charCodeAt(n)+(t<<5)-t}var r=Math.abs(t%i.liste.length);return i.liste[r]}function V(e){$connectedDiv=$(".connected");$connectedDiv.text("User List");$.each(e,function(e,t){$connectedDiv=$(".connected");$connectedDiv.append("<div class='userlist' style='color:"+X(t)+";'>"+t+"</div>")})}function J(){var e="<ul><li>...</li>"+"<li><span class='nom_cmd'>Show commands:</span>"+"<span class='syntax_cmd'>/help</span></li>"+"<li><span class='nom_cmd'>Version:</span>"+"<span class='syntax_cmd'>/version</span></li>"+"<li><span class='nom_cmd'>Pong:</span>"+"<span class='syntax_cmd'>/ping</span></li>"+"<li><span class='nom_cmd'>Clear chat:</span>"+"<span class='syntax_cmd'>/clear</span></li>"+"<li><span class='nom_cmd'>Print image:</span>"+"<span class='syntax_cmd'>/img #url</span></li>"+"<li><span class='nom_cmd'>Print link:</span>"+"<span class='syntax_cmd'>/#url</span></li>"+"<li><span class='nom_cmd'>Leave:</span>"+"<span class='syntax_cmd'>/quit</span></li>"+"<li><span class='nom_cmd'>Connected list:</span>"+"<span class='syntax_cmd'>/ls</span></li>";if(w>=1){e+="<li><span class='nom_cmd'>Print Youtube video:</span>"+"<span class='syntax_cmd'>/yt #url</span></li>"+"<li><span class='nom_cmd'>Print Tweet:</span>"+"<span class='syntax_cmd'>/tw #code</span></li>"+"<li><span class='nom_cmd'>Connection :</span>"+"<span class='syntax_cmd'>/pass #password</span></li>"+"<li><span class='nom_cmd'>Play Youtube video :</span>"+"<span class='syntax_cmd'>/playYt #url</span></li>"}if(w>=2){e+="<li><span class='nom_cmd'>Kick:</span>"+"<span class='syntax_cmd'>/kick @#username</span></li>"+"<li><span class='nom_cmd'>Announcement:</span>"+"<span class='syntax_cmd'>/announce #duration(in seconds) #message</span></li>"+"<li><span class='nom_cmd'>Broadcast :</span>"+"<span class='syntax_cmd'>/say #message</span></li>"}if(w>=3){}e+="</ul>";return e}function Q(e){var t;t=document.getElementById(e);if(t.style.opacity==0){t.style.display="";setTimeout(function(){t.style.opacity=1},100);return"unHide"}else{t.style.opacity=0;setTimeout(function(){t.style.display="none"},600);return"Hide"}}function G(e){var t=new Howl({urls:["sound/"+e+".mp3"]});if(d&&b){t.play()}}function Y(){var e=".but_smiley";Q("smiley_list");if($(e).val()=="Smiley"){$(e).val("-");$(e).css("left","200px")}else{$(e).val("Smiley");$(e).css("left","0px")}}function Z(){var e=".but_co";Q("co_list");if($(e).val()=="Connected"){$(e).val("-");$(e).css("right","150px")}else{$(e).val("Connected");$(e).css("right","0px")}}function et(e){var t=document.title;var n=t.indexOf("(");var r=t.indexOf(")");switch(e){case"New_message":if(n>=0&&r>=0){var i=parseInt(t.substr(n+1,r-1))+1;document.title="("+i+") "+t.substring(r+1,100)}else{document.title="(1) "+t}break;case"Cleen":document.title=document.title.substring(r+1,100);break;default:break}}function tt(e,t){var n="<img src='images/announce.png' />";var r="<input type='submit' class='but_closeAnnounce' value='x'>";$(".announce").html(r+n+e);if($(".announce").css("opacity")==0){Q("announceDiv");setTimeout(function(){Q("announceDiv");if($(".announce").html()==""){setTimeout(function(){Q("announceDiv")},100)}},t*1e3)}}var e="1.8.4.5";var t=150;var n=400;var r=3e3;var i=new N("Colors");var s=new N("Smiley");var o=new N("BannedWords");var u=new N("Password");var a=$(window);var f=$(".usernameInput");var l=$(".messages");var c=$(".connected");var h=$(".inputMessage");var p=$(".username");var d=false;var v=$(".login.page");var m=$(".chat.page");var g;var y;var b=false;var w=0;var E=false;var S;var x=f.focus();var T=io();$(function(){$.each(s.liste,function(e,t){$connectedDiv=$(".Lsmiley");$proposalDiv=$(".smileyProposal");$proposalDiv.append('<option value="'+e+'"></option>');if(t){$connectedDiv.append("<span class='smileylist'><img src='smiley/"+t+".gif' class='smiley' id='"+e+"'/></span>")}else{$connectedDiv.append("<span class='smileylist'><span class='smiley' id='"+e+"'>"+e+"</span></span>")}})});var K=1;a.keydown(function(e){if(!(e.ctrlKey||e.metaKey||e.altKey)){x.focus();et("Cleen")}switch(e.which){case 13:if(g){_();T.emit("stop typing");E=false}else{L()}break;case 37:Y();break;case 39:Z();break;case 16:if(K>=5){G("mention")}else{K++};default:break}if(e.which!=16)K=1});h.on("input",function(){z()});var d=true;v.click(function(){x.focus()});h.click(function(){h.focus()});l.on("click",".username",function(){var e=$(this).text();var t=e.split(" ")[0];var n=h.val();h.val(n+" @"+t+" ");x.focus()});$(".connected").on("click",".userlist",function(){var e=$(this).text();var t=e.split(" ")[0];var n=h.val();h.val(n+" @"+t+" ");x.focus()});$(".Lsmiley").on("click",".smiley",function(){var e=$(this).attr("id");var t=h.val();h.val(t+" "+e+" ");x.focus();$(".but_smiley").trigger("click")});$(".but_smiley").click(Y);$(".but_co").click(Z);$(".messages").on("click",".adminDiv",function(){var e=$(this).parent().get(0).className.split("-")[1].split(" ")[0];if(w>=2){T.emit("delete",{ID:e});$(".message-"+e+" span.messageBody").html("Message Supprimé").attr("id","deleted");$(".message-"+e+" span.adminDiv").html("")}});$(".but_sound").click(function(){if(this.id=="unmute"){$(".but_sound").attr("id","mute").css("background-image","url('images/sound/mute.png')");d=false}else{$(".but_sound").attr("id","unmute").css("background-image","url('images/sound/unmute.png')");d=true}});$(".announce").on("click",".but_closeAnnounce",function(){Q("announceDiv");setTimeout(function(){$(".announce").html("")},600)});T.on("login",function(e){G("login");d=true;b=true;g=e.username;y=e.allUsers;V(y);var t="Welcome to Socket.IO Chat";if(g.split("-")[0]=="visiteur"){t="Invalid Username"}D(t,{prepend:true});k(e)});T.on("new message",function(e){G("new_msg");et("New_message");if(e.message.indexOf("@"+g+" ")!=-1){e.mention=true}else{e.mention=false}P(e)});T.on("user joined",function(e){G("join");D(e.username+" joined");k(e);y=e.allUsers;V(y)});T.on("user left",function(e){G("leave");D(e.username+" left");k(e);B(e);y=e.allUsers;V(y)});T.on("typing",function(e){H(e)});T.on("stop typing",function(e){B(e)});T.on("disconnect",function(){P({username:"<Server>",message:"Server down... Please Wait..."});setTimeout(function(){location.reload()},5e3)});T.on("kick",function(e){if("@"+g==e.username&&w<e.rang){T.disconnect();P({username:"<Server>",message:"Kicked by <span style='color:"+X(e.moderator)+"; font-weight:700;'>"+e.moderator+"</span>"})}});T.on("delete",function(e){$(".message-"+e.ID+" span.messageBody").html("Message Supprimé").attr("id","deleted")});T.on("announce",function(e){tt(e.message,e.duree)});T.on("playYt",function(e){console.log(e);tt(e.video,e.duree)})})